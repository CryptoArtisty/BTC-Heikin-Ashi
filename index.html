<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Heikin Ashi Trading System - Responsive Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Glass morphism effect */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Enhanced gradients */
        .gradient-primary {
            background: var(--primary-bg);
        }

        .gradient-success {
            background: var(--success-gradient);
        }

        .gradient-danger {
            background: var(--danger-gradient);
        }

        .gradient-warning {
            background: var(--warning-gradient);
        }

        /* Chart container */
        .chart-container {
            height: 70vh;
            min-height: 500px;
            width: 100%;
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 20px;
            z-index: -1;
        }

        #chart {
            width: 100%;
            height: 100%;
            border-radius: 16px;
        }

        /* Enhanced buttons */
        .btn-primary {
            background: var(--primary-bg);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(17, 153, 142, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.4);
        }

        /* Enhanced form elements */
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: #ffffff;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Status badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .status-connected {
            background: rgba(17, 153, 142, 0.2);
            border: 1px solid rgba(17, 153, 142, 0.3);
            color: #38ef7d;
        }

        .status-disconnected {
            background: rgba(238, 9, 121, 0.2);
            border: 1px solid rgba(238, 9, 121, 0.3);
            color: #ff6a00;
        }

        /* Alert styles */
        .alert {
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 4px 4px 0;
        }

        .alert.buy::before {
            background: var(--success-gradient);
        }

        .alert.sell::before {
            background: var(--danger-gradient);
        }

        .alert.system::before {
            background: var(--primary-bg);
        }

        .alert.buy {
            background: rgba(17, 153, 142, 0.1);
            border-left-color: #11998e;
        }

        .alert.sell {
            background: rgba(238, 9, 121, 0.1);
            border-left-color: #ee0979;
        }

        .alert.system {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-bg);
            border-radius: 4px;
        }

        /* Enhanced stats cards */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.02);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chart-container {
                height: 50vh;
                min-height: 400px;
                padding: 16px;
                border-radius: 16px;
            }

            .mobile-hide {
                display: none;
            }

            .mobile-stack {
                flex-direction: column;
            }

            .mobile-full {
                width: 100%;
            }

            .glass-card {
                margin-bottom: 16px;
            }
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 45vh;
                min-height: 350px;
                padding: 12px;
            }

            .btn-primary, .btn-success {
                padding: 10px 20px;
                font-size: 0.875rem;
            }

            .status-badge {
                padding: 6px 12px;
                font-size: 0.75rem;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Enhanced trade history */
        .trade-history {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .trade-profit {
            color: #38ef7d;
            font-weight: 600;
        }

        .trade-loss {
            color: #ff6a00;
            font-weight: 600;
        }

        /* Color picker styling */
        input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-bg);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        /* Loading animation */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Collapsible card styles */
        .collapsible-card {
            transition: all 0.3s ease;
        }

        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
        }

        .collapsible-header h2, 
        .collapsible-header h3 {
            margin: 0;
        }

        .collapsible-content {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-icon {
            transition: transform 0.3s ease;
        }

        .collapsible-card.collapsed .collapsible-content {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
            border: none;
        }

        .collapsible-card.collapsed .collapsible-icon {
            transform: rotate(-90deg);
        }

        /* Checklist styles */
        .checklist {
            margin-top: 1rem;
        }

        .checklist-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #667eea;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .checklist-checkbox {
            margin-right: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checklist-checkbox.checked {
            background-color: #38ef7d;
            border-color: #38ef7d;
        }

        .checklist-checkbox.unchecked {
            background-color: #ff6a00;
            border-color: #ff6a00;
        }

        .checklist-checkbox i {
            font-size: 0.75rem;
            color: white;
        }

        .checklist-label {
            flex: 1;
        }

        .checklist-label.checked {
            color: #38ef7d;
        }

        .checklist-label.unchecked {
            color: #ff6a00;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Background decoration -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 opacity-10 blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full bg-gradient-to-br from-blue-400 to-indigo-400 opacity-10 blur-3xl"></div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl relative z-10">
        <!-- Enhanced Header -->
        <header class="glass-card rounded-2xl p-6 mb-8 animate-fadeInUp">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
                        <i class="fas fa-chart-line mr-3 text-purple-400"></i>Enhanced Heikin Ashi Trading System
                    </h1>
                    <p class="text-gray-300 text-lg">Professional 1-minute Heikin Ashi strategy with EMA & ATR filters</p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <span id="connectionStatus" class="status-badge status-disconnected">
                        <div class="loading-spinner"></div>
                        Connecting...
                    </span>
                    <div class="text-sm space-y-1">
                        <div id="lastUpdate" class="text-gray-400">
                            <i class="fas fa-clock mr-1"></i>Initializing...
                        </div>
                        <div id="accountBalance" class="text-green-400 font-semibold">
                            <i class="fas fa-wallet mr-1"></i>Balance: $10,000.00
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Enhanced Dashboard -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 lg:gap-8">
            <!-- Enhanced Control Panel -->
            <div class="xl:col-span-1 space-y-6">
                <!-- Trading Settings -->
                <div class="glass-card rounded-2xl animate-fadeInUp collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-cog mr-3 text-purple-400"></i>
                            <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Trading Settings</span>
                        </h2>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content p-6">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-gray-300 font-medium mb-3 flex items-center">
                                    <i class="fas fa-percentage mr-2 text-purple-400"></i>Doji Body Ratio
                                </label>
                                <input type="number" id="dojiRatio" value="0.08" step="0.01" min="0.01" max="0.2" 
                                       class="form-input w-full">
                                <p class="text-xs text-gray-400 mt-2">Max body size relative to candle range (0.01-0.2)</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 font-medium mb-3 flex items-center">
                                    <i class="fas fa-chart-bar mr-2 text-purple-400"></i>Volume MA Period
                                </label>
                                <input type="number" id="volumeMAPeriod" value="20" min="5" max="50" 
                                       class="form-input w-full">
                                <p class="text-xs text-gray-400 mt-2">Periods for volume moving average (5-50)</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 font-medium mb-3 flex items-center">
                                    <i class="fas fa-dollar-sign mr-2 text-purple-400"></i>Trade Size (%)
                                </label>
                                <input type="number" id="tradeSize" value="2" min="1" max="10" 
                                       class="form-input w-full">
                                <p class="text-xs text-gray-400 mt-2">Risk per trade (1%-10% of balance)</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-300 font-medium mb-3 flex items-center">
                                    <i class="fas fa-bullseye mr-2 text-purple-400"></i>ATR Multiplier
                                </label>
                                <input type="number" id="atrMultiplier" value="1.5" step="0.1" min="1" max="3" 
                                       class="form-input w-full">
                                <p class="text-xs text-gray-400 mt-2">Stop loss/take profit distance (1-3x ATR)</p>
                            </div>
                            
                            <button id="applySettings" class="btn-primary w-full flex items-center justify-center gap-2">
                                <i class="fas fa-check"></i>Apply Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MA Customization -->
                <div class="glass-card rounded-2xl animate-fadeInUp collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-sliders-h mr-2 text-blue-400"></i>MA Customization
                        </h3>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content p-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300 text-sm">EMA 50</span>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="ema50Color" value="#f1c40f" class="rounded-lg">
                                    <input type="range" id="ema50Width" min="1" max="5" value="1" class="w-16">
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300 text-sm">EMA 100</span>
                                <div class="flex items-center gap-3">
                                    <input type="color" id="ema100Color" value="#e67e22" class="rounded-lg">
                                    <input type="range" id="ema100Width" min="1" max="5" value="2" class="w-16">
                                </div>
                            </div>
                            
                            <button id="applyMAstyles" class="btn-success w-full flex items-center justify-center gap-2 mt-4">
                                <i class="fas fa-paint-brush"></i>Apply Styles
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Live Statistics -->
                <div class="glass-card rounded-2xl animate-fadeInUp collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-chart-area mr-2 text-green-400"></i>Live Statistics
                        </h3>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content p-6">
                        <div class="space-y-3">
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">Current Price</span>
                                <span id="currentPrice" class="text-green-400 font-mono font-semibold">-</span>
                            </div>
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">EMA 50</span>
                                <span id="ema50" class="text-yellow-400 font-mono font-semibold">-</span>
                            </div>
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">EMA 100</span>
                                <span id="ema100" class="text-orange-400 font-mono font-semibold">-</span>
                            </div>
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">ATR (14)</span>
                                <span id="atrValue" class="text-blue-400 font-mono font-semibold">-</span>
                            </div>
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">Position</span>
                                <span id="currentPosition" class="text-blue-400 font-mono font-semibold">None</span>
                            </div>
                            <div class="stat-card flex justify-between items-center">
                                <span class="text-gray-400 text-sm">Today's P/L</span>
                                <span id="dailyPL" class="text-green-400 font-mono font-semibold">$0.00</span>
                            </div>
                            
                            <!-- Trade Requirements Checklist -->
                            <div class="stat-card">
                                <div id="tradeConditionsChecklist">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Signals -->
                <div class="glass-card rounded-2xl animate-fadeInUp collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-bell mr-2 text-yellow-400"></i>Active Signals
                        </h3>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content p-6">
                        <div id="signals" class="space-y-2 max-h-48 overflow-y-auto">
                            <div class="text-gray-400 text-sm text-center py-4">
                                <i class="fas fa-hourglass-half animate-pulse-custom mb-2 block text-lg"></i>
                                Waiting for signals...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Chart Section -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Chart Container -->
                <div class="glass-card chart-container animate-fadeInUp">
                    <div id="chart"></div>
                </div>
                
                <!-- Strategy Guide -->
                <div class="glass-card rounded-2xl animate-fadeInUp collapsible-card">
                    <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                        <h3 class="text-xl font-bold flex items-center">
                            <i class="fas fa-book mr-3 text-indigo-400"></i>
                            <span class="bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Strategy Guide</span>
                        </h3>
                        <i class="fas fa-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h4 class="font-semibold text-purple-300 text-lg">How It Works:</h4>
                                <ol class="list-decimal list-inside space-y-2 text-gray-300">
                                    <li><strong>Trend Identification</strong>: Only trade when EMA 50 is above/below EMA 100</li>
                                    <li><strong>Entry Signal</strong>: Doji candles after pullback to EMA 100</li>
                                    <li><strong>Volume Confirmation</strong>: 1.5x above 20-period MA</li>
                                    <li><strong>Market Structure</strong>: Higher lows in uptrends</li>
                                    <li><strong>Risk Management</strong>: 1.5x ATR stops with dual targets</li>
                                </ol>
                            </div>
                            
                            <div class="space-y-4">
                                <h4 class="font-semibold text-purple-300 text-lg">Why It's Profitable:</h4>
                                <ul class="list-disc list-inside space-y-2 text-gray-300">
                                    <li>Heikin Ashi filters market noise</li>
                                    <li>EMA crossover confirms direction</li>
                                    <li>Doji patterns identify reversals</li>
                                    <li>Volume ensures institutional participation</li>
                                    <li>ATR stops adapt to volatility</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h4 class="font-semibold text-purple-300 text-lg mb-4">Parameter Optimization:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="glass-card p-4 rounded-xl">
                                    <h5 class="font-semibold text-blue-300 mb-2">Doji Body Ratio (0.01-0.2)</h5>
                                    <p class="text-sm text-gray-300">Lower values = stricter requirements. Try 0.05-0.1 for precision.</p>
                                </div>
                                <div class="glass-card p-4 rounded-xl">
                                    <h5 class="font-semibold text-blue-300 mb-2">Volume MA Period (5-50)</h5>
                                    <p class="text-sm text-gray-300">Higher values = smoother average. 20 works well for 1-minute charts.</p>
                                </div>
                                <div class="glass-card p-4 rounded-xl">
                                    <h5 class="font-semibold text-blue-300 mb-2">Trade Size (1%-10%)</h5>
                                    <p class="text-sm text-gray-300">Risk per trade. Conservative: 1-2%, aggressive: 3-5%.</p>
                                </div>
                                <div class="glass-card p-4 rounded-xl">
                                    <h5 class="font-semibold text-blue-300 mb-2">ATR Multiplier (1-3)</h5>
                                    <p class="text-sm text-gray-300">Higher = wider stops (fewer wins, bigger profits). 1.5-2 optimal.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Trade History -->
        <div class="mt-8 glass-card rounded-2xl animate-fadeInUp collapsible-card">
            <div class="collapsible-header" onclick="toggleCollapse(this.parentElement)">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between w-full gap-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-history mr-3 text-green-400"></i>
                        <span class="bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">Trade History</span>
                    </h2>
                    <button id="clearHistory" class="btn-primary bg-red-500 hover:bg-red-600 flex items-center gap-2 text-sm px-4 py-2">
                        <i class="fas fa-trash"></i>Clear History
                    </button>
                </div>
                <i class="fas fa-chevron-down collapsible-icon"></i>
            </div>
            <div class="collapsible-content p-6">
                <div id="tradeHistory" class="trade-history">
                    <div class="text-gray-400 text-center py-8">
                        <i class="fas fa-chart-line text-3xl mb-4 opacity-50"></i>
                        <p>No trades yet. Waiting for signals...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chart;
        let candleSeries;
        let volumeSeries;
        let ema50Series;
        let ema100Series;
        let volumeMASeries;
        let socket;
        let currentTimeframe = '1m';
        let candles = [];
        let heikinAshiCandles = [];
        let volumeData = [];
        let ema50Data = [];
        let ema100Data = [];
        let atrData = [];
        let volumeMAData = [];
        let signalCounter = 0;
        let lastPrice = 0;
        let accountBalance = 10000;
        let dailyPL = 0;
        let currentPosition = null;
        let tradeHistory = [];
        let markers = [];
        let currentTradeConditions = {
            buy: {
                trend: false,
                doji: false,
                volume: false,
                marketStructure: false,
                pullback: false
            },
            sell: {
                trend: false,
                doji: false,
                volume: false,
                marketStructure: false,
                pullback: false
            }
        };

        // Collapse toggle function
        function toggleCollapse(card) {
            card.classList.toggle('collapsed');
        }

        // Update trade conditions checklist
        function updateTradeConditionsChecklist() {
            const checklistContainer = document.getElementById('tradeConditionsChecklist');
            
            let html = `
                <div class="checklist">
                    <div class="checklist-title">Buy Conditions:</div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.buy.trend ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.buy.trend ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.buy.trend ? 'checked' : 'unchecked'}">
                            EMA 50 > EMA 100 (Trend)
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.buy.doji ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.buy.doji ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.buy.doji ? 'checked' : 'unchecked'}">
                            Valid Doji Pattern
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.buy.volume ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.buy.volume ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.buy.volume ? 'checked' : 'unchecked'}">
                            Volume 1.5x > MA
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.buy.marketStructure ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.buy.marketStructure ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.buy.marketStructure ? 'checked' : 'unchecked'}">
                            Higher Lows (Market Structure)
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.buy.pullback ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.buy.pullback ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.buy.pullback ? 'checked' : 'unchecked'}">
                            Clean Pullback to EMA 100
                        </div>
                    </div>
                </div>
                
                <div class="checklist mt-4">
                    <div class="checklist-title">Sell Conditions:</div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.sell.trend ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.sell.trend ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.sell.trend ? 'checked' : 'unchecked'}">
                            EMA 50 < EMA 100 (Trend)
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.sell.doji ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.sell.doji ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.sell.doji ? 'checked' : 'unchecked'}">
                            Valid Doji Pattern
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.sell.volume ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.sell.volume ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.sell.volume ? 'checked' : 'unchecked'}">
                            Volume 1.5x > MA
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.sell.marketStructure ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.sell.marketStructure ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.sell.marketStructure ? 'checked' : 'unchecked'}">
                            Lower Highs (Market Structure)
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${currentTradeConditions.sell.pullback ? 'checked' : 'unchecked'}">
                            <i class="fas fa-${currentTradeConditions.sell.pullback ? 'check' : 'times'}"></i>
                        </div>
                        <div class="checklist-label ${currentTradeConditions.sell.pullback ? 'checked' : 'unchecked'}">
                            Clean Pullback to EMA 100
                        </div>
                    </div>
                </div>
            `;
            
            checklistContainer.innerHTML = html;
        }

        // Initialize the application
        function initializeApp() {
            try {
                // Load trade history from local storage
                loadTradeHistory();
                updateAccountDisplay();
                
                setupChart();
                loadInitialData();
                setupEventListeners();
                addAlert('Enhanced system initialized successfully', 'system');
                
                // Initialize trade conditions checklist
                updateTradeConditionsChecklist();
            } catch (error) {
                console.error('Initialization error:', error);
                addAlert('Failed to initialize application', 'system');
            }
        }

        // Setup chart
        function setupChart() {
            const chartContainer = document.getElementById('chart');
            if (!chartContainer) {
                throw new Error('Chart container not found');
            }

            chart = LightweightCharts.createChart(chartContainer, {
                layout: {
                    backgroundColor: 'transparent',
                    textColor: '#e0e0e0',
                    fontSize: 12,
                },
                grid: {
                    vertLines: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        style: 1,
                    },
                    horzLines: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        style: 1,
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.4,
                    },
                },
                timeScale: {
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    timeVisible: true,
                    secondsVisible: false,
                },
                watermark: {
                    color: 'rgba(102, 126, 234, 0.5)',
                    visible: true,
                    text: 'BTC/USDT (Enhanced Heikin Ashi)',
                    fontSize: 24,
                    horzAlign: 'center',
                    vertAlign: 'center',
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#38ef7d',
                downColor: '#ff6a00',
                borderDownColor: '#ff6a00',
                borderUpColor: '#38ef7d',
                wickDownColor: '#ff6a00',
                wickUpColor: '#38ef7d',
                priceScaleId: 'right',
            });

            ema50Series = chart.addLineSeries({
                color: '#f1c40f',
                lineWidth: 1,
                priceScaleId: 'right',
            });

            ema100Series = chart.addLineSeries({
                color: '#e67e22',
                lineWidth: 2,
                priceScaleId: 'right',
            });

            volumeSeries = chart.addHistogramSeries({
                color: '#667eea',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
                scaleMargins: {
                    top: 0.7,
                    bottom: 0,
                },
            });

            volumeMASeries = chart.addLineSeries({
                color: '#3498db',
                lineWidth: 1,
                priceScaleId: '',
                scaleMargins: {
                    top: 0.7,
                    bottom: 0,
                },
            });

            // Handle chart resize
            const resizeObserver = new ResizeObserver(entries => {
                if (chart) {
                    chart.applyOptions({
                        width: entries[0].contentRect.width,
                        height: entries[0].contentRect.height,
                    });
                }
            });
            resizeObserver.observe(chartContainer);
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('applySettings').addEventListener('click', () => {
                addAlert('Trading settings applied successfully', 'system');
            });
            
            document.getElementById('applyMAstyles').addEventListener('click', () => {
                applyMAstyles();
                addAlert('MA styles updated successfully', 'system');
            });
            
            document.getElementById('clearHistory').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all trade history?')) {
                    localStorage.removeItem('heikinAshiTradeHistory');
                    localStorage.removeItem('heikinAshiAccountBalance');
                    tradeHistory = [];
                    accountBalance = 10000;
                    dailyPL = 0;
                    updateTradeHistoryDisplay();
                    updateAccountDisplay();
                    addAlert('Trade history cleared', 'system');
                }
            });
        }

        // Apply MA style changes
        function applyMAstyles() {
            const ema50Color = document.getElementById('ema50Color').value;
            const ema50Width = parseInt(document.getElementById('ema50Width').value);
            const ema100Color = document.getElementById('ema100Color').value;
            const ema100Width = parseInt(document.getElementById('ema100Width').value);
            
            ema50Series.applyOptions({
                color: ema50Color,
                lineWidth: ema50Width
            });
            
            ema100Series.applyOptions({
                color: ema100Color,
                lineWidth: ema100Width
            });
        }

        // Convert regular candles to Heikin Ashi candles
        function convertToHeikinAshi(regularCandles) {
            const haCandles = [];
            
            for (let i = 0; i < regularCandles.length; i++) {
                const current = regularCandles[i];
                const prevHa = haCandles[i - 1] || current;
                
                const haClose = (current.open + current.high + current.low + current.close) / 4;
                const haOpen = (prevHa.open + prevHa.close) / 2;
                const haHigh = Math.max(current.high, haOpen, haClose);
                const haLow = Math.min(current.low, haOpen, haClose);
                
                haCandles.push({
                    time: current.time,
                    open: haOpen,
                    high: haHigh,
                    low: haLow,
                    close: haClose,
                    volume: current.volume,
                    originalOpen: current.open,
                    originalClose: current.close,
                    originalHigh: current.high,
                    originalLow: current.low
                });
            }
            
            return haCandles;
        }

        // Calculate EMA
        function calculateEMA(data, period, key = 'close') {
            const emaData = [];
            let sum = 0;
            const multiplier = 2 / (period + 1);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    sum += data[i][key];
                    if (i === period - 1) {
                        emaData.push({ time: data[i].time, value: sum / period });
                    }
                } else {
                    const ema = (data[i][key] - emaData[i - period].value) * multiplier + emaData[i - period].value;
                    emaData.push({ time: data[i].time, value: ema });
                }
            }
            
            return emaData;
        }

        // Calculate ATR (Average True Range)
        function calculateATR(data, period = 14) {
            const atrData = [];
            let sumTR = 0;
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    atrData.push({ time: data[i].time, value: 0 });
                    continue;
                }
                
                const prevClose = data[i-1].close;
                const trueRange = Math.max(
                    data[i].high - data[i].low,
                    Math.abs(data[i].high - prevClose),
                    Math.abs(data[i].low - prevClose)
                );
                
                if (i < period) {
                    sumTR += trueRange;
                    if (i === period - 1) {
                        atrData.push({ time: data[i].time, value: sumTR / period });
                    }
                } else {
                    const atr = ((atrData[i - period].value * (period - 1)) + trueRange) / period;
                    atrData.push({ time: data[i].time, value: atr });
                }
            }
            
            return atrData;
        }

        // Calculate moving average
        function calculateMA(data, period, key = 'value') {
            const maData = [];
            let sum = 0;
            
            for (let i = 0; i < data.length; i++) {
                sum += data[i][key];
                
                if (i >= period) {
                    sum -= data[i - period][key];
                    maData.push({ time: data[i].time, value: sum / period });
                } else if (i === period - 1) {
                    maData.push({ time: data[i].time, value: sum / period });
                }
            }
            
            return maData;
        }

        // Load trade history from local storage
        function loadTradeHistory() {
            const savedHistory = localStorage.getItem('heikinAshiTradeHistory');
            const savedBalance = localStorage.getItem('heikinAshiAccountBalance');
            
            if (savedHistory) {
                tradeHistory = JSON.parse(savedHistory);
                updateTradeHistoryDisplay();
            }
            
            if (savedBalance) {
                accountBalance = parseFloat(savedBalance);
            }
        }

        // Save trade history to local storage
        function saveTradeHistory() {
            localStorage.setItem('heikinAshiTradeHistory', JSON.stringify(tradeHistory));
            localStorage.setItem('heikinAshiAccountBalance', accountBalance.toString());
        }

        // Load initial historical data
        async function loadInitialData() {
            try {
                updateConnectionStatus('connecting');
                addAlert(`Loading ${currentTimeframe} data...`, 'system');
                
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${currentTimeframe}&limit=200`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Invalid data received from API');
                }
                
                // Process initial data
                candles = data.map(k => ({
                    time: Math.floor(k[0] / 1000),
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                    volume: parseFloat(k[5]),
                }));
                
                // Convert to Heikin Ashi
                heikinAshiCandles = convertToHeikinAshi(candles);
                
                // Calculate indicators
                ema50Data = calculateEMA(heikinAshiCandles, 50);
                ema100Data = calculateEMA(heikinAshiCandles, 100);
                atrData = calculateATR(heikinAshiCandles, 14);
                
                volumeData = data.map(k => ({
                    time: Math.floor(k[0] / 1000),
                    value: parseFloat(k[5]),
                    color: parseFloat(k[4]) >= parseFloat(k[1]) ? '#38ef7d' : '#ff6a00',
                }));
                
                volumeMAData = calculateMA(volumeData, 20);
                
                // Set chart data
                candleSeries.setData(heikinAshiCandles);
                ema50Series.setData(ema50Data);
                ema100Series.setData(ema100Data);
                volumeSeries.setData(volumeData);
                volumeMASeries.setData(volumeMAData);
                
                // Update UI with latest data
                const latestCandle = candles[candles.length - 1];
                updatePriceDisplay(latestCandle);
                
                // Connect WebSocket after successful data load
                connectWebSocket();
                
                addAlert(`Loaded ${data.length} candles successfully`, 'system');
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                addAlert(`Error loading data: ${error.message}`, 'system');
                updateConnectionStatus('error');
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            if (socket) {
                socket.close();
            }

            const wsUrl = `wss://stream.binance.com:9443/ws/btcusdt@kline_${currentTimeframe}`;
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus('connected');
                addAlert('Connected to Binance WebSocket', 'system');
            };
            
            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.k) {
                        processKlineData(message.k);
                    }
                } catch (error) {
                    console.error('Error processing WebSocket message:', error);
                }
            };
            
            socket.onclose = (event) => {
                console.log('WebSocket disconnected', event.code, event.reason);
                updateConnectionStatus('disconnected');
                addAlert('Disconnected from Binance', 'system');
                
                // Attempt to reconnect after 5 seconds
                setTimeout(() => {
                    if (socket && socket.readyState === WebSocket.CLOSED) {
                        connectWebSocket();
                    }
                }, 5000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error');
                addAlert('WebSocket connection error', 'system');
            };
        }

        // Process kline data from WebSocket
        function processKlineData(kline) {
            try {
                const newCandle = {
                    time: Math.floor(kline.t / 1000),
                    open: parseFloat(kline.o),
                    high: parseFloat(kline.h),
                    low: parseFloat(kline.l),
                    close: parseFloat(kline.c),
                    volume: parseFloat(kline.v),
                };

                // Update or add candle
                if (candles.length > 0 && candles[candles.length - 1].time === newCandle.time) {
                    candles[candles.length - 1] = newCandle;
                } else {
                    candles.push(newCandle);
                    if (candles.length > 1000) {
                        candles.shift();
                    }
                }

                // Convert to Heikin Ashi
                heikinAshiCandles = convertToHeikinAshi(candles);
                const latestHaCandle = heikinAshiCandles[heikinAshiCandles.length - 1];
                
                // Calculate indicators
                ema50Data = calculateEMA(heikinAshiCandles, 50);
                ema100Data = calculateEMA(heikinAshiCandles, 100);
                atrData = calculateATR(heikinAshiCandles, 14);
                
                // Update chart data
                candleSeries.update(latestHaCandle);
                ema50Series.setData(ema50Data);
                ema100Series.setData(ema100Data);

                // Update volume data
                const volumeItem = {
                    time: newCandle.time,
                    value: newCandle.volume,
                    color: newCandle.close >= newCandle.open ? '#38ef7d' : '#ff6a00',
                };

                if (volumeData.length > 0 && volumeData[volumeData.length - 1].time === newCandle.time) {
                    volumeData[volumeData.length - 1] = volumeItem;
                } else {
                    volumeData.push(volumeItem);
                    if (volumeData.length > 1000) {
                        volumeData.shift();
                    }
                }

                volumeMAData = calculateMA(volumeData, 20);
                volumeSeries.update(volumeItem);
                volumeMASeries.setData(volumeMAData);

                // Update UI
                updatePriceDisplay(newCandle);
                updateLastUpdate();
                
                const latestEMA50 = ema50Data[ema50Data.length - 1];
                const latestEMA100 = ema100Data[ema100Data.length - 1];
                const latestATR = atrData[atrData.length - 1];
                
                document.getElementById('ema50').textContent = latestEMA50 ? `$${latestEMA50.value.toFixed(2)}` : '-';
                document.getElementById('ema100').textContent = latestEMA100 ? `$${latestEMA100.value.toFixed(2)}` : '-';
                document.getElementById('atrValue').textContent = latestATR ? latestATR.value.toFixed(2) : '-';

                // Update trade conditions
                updateTradeConditions(latestHaCandle, latestEMA50, latestEMA100, latestATR);

                // Detect trade signals if candle is closed
                if (kline.x) {
                    detectTradeSignal(latestHaCandle, latestEMA50, latestEMA100, latestATR);
                }

            } catch (error) {
                console.error('Error processing kline data:', error);
            }
        }

        // Update trade conditions
        function updateTradeConditions(candle, ema50, ema100, atr) {
            // Reset conditions
            currentTradeConditions = {
                buy: {
                    trend: false,
                    doji: false,
                    volume: false,
                    marketStructure: false,
                    pullback: false
                },
                sell: {
                    trend: false,
                    doji: false,
                    volume: false,
                    marketStructure: false,
                    pullback: false
                }
            };

            // Check for buy conditions
            if (ema50 && ema100) {
                currentTradeConditions.buy.trend = ema50.value > ema100.value;
                currentTradeConditions.sell.trend = ema50.value < ema100.value;
            }

            if (candle) {
                const isDoji = isEnhancedDoji(candle, atr);
                currentTradeConditions.buy.doji = isDoji && candle.close > candle.open;
                currentTradeConditions.sell.doji = isDoji && candle.close < candle.open;
            }

            if (volumeData.length > 0 && volumeMAData.length > 0) {
                const currentVolume = volumeData[volumeData.length - 1].value;
                const currentVolumeMA = volumeMAData[volumeMAData.length - 1].value;
                const volumeValid = currentVolume >= currentVolumeMA * 1.5;
                currentTradeConditions.buy.volume = volumeValid;
                currentTradeConditions.sell.volume = volumeValid;
            }

            if (heikinAshiCandles.length >= 5) {
                currentTradeConditions.buy.marketStructure = checkMarketStructure(heikinAshiCandles.slice(-5), true);
                currentTradeConditions.sell.marketStructure = checkMarketStructure(heikinAshiCandles.slice(-5), false);
            }

            if (heikinAshiCandles.length >= 3) {
                currentTradeConditions.buy.pullback = checkCleanPullback(heikinAshiCandles, 'buy');
                currentTradeConditions.sell.pullback = checkCleanPullback(heikinAshiCandles, 'sell');
            }

            // Update the checklist display
            updateTradeConditionsChecklist();
        }

        // Enhanced Doji detection with ATR filter
        function isEnhancedDoji(candle, atr) {
            if (!atr || atr.value === 0) return false;
            
            const bodySize = Math.abs(candle.close - candle.open);
            const range = candle.high - candle.low;
            const dojiRatio = parseFloat(document.getElementById('dojiRatio').value) || 0.08;
            const atrRatio = bodySize / (atr.value * 0.1); // Normalize against volatility
            
            return range > 0 && 
                   bodySize <= range * dojiRatio && 
                   atrRatio < 0.5;
        }

        // Check market structure
        function checkMarketStructure(recentCandles, isBullish) {
            if (recentCandles.length < 3) return false;
            
            if (isBullish) {
                // Check for higher lows in bullish trend
                return recentCandles[1].low > recentCandles[0].low && 
                       recentCandles[2].low > recentCandles[1].low;
            } else {
                // Check for lower highs in bearish trend
                return recentCandles[1].high < recentCandles[0].high && 
                       recentCandles[2].high < recentCandles[1].high;
            }
        }

        // Check for clean pullback
        function checkCleanPullback(candles, direction) {
            if (candles.length < 3) return false;
            
            const recentCandles = candles.slice(-3);
            
            if (direction === 'buy') {
                // Need at least 2 red candles with no upper wicks
                return recentCandles[0].close < recentCandles[0].open &&
                       recentCandles[1].close < recentCandles[1].open &&
                       Math.abs(recentCandles[0].high - Math.max(recentCandles[0].open, recentCandles[0].close)) < 0.000001 &&
                       Math.abs(recentCandles[1].high - Math.max(recentCandles[1].open, recentCandles[1].close)) < 0.000001;
            } else if (direction === 'sell') {
                // Need at least 2 green candles with no lower wicks
                return recentCandles[0].close > recentCandles[0].open &&
                       recentCandles[1].close > recentCandles[1].open &&
                       Math.abs(Math.min(recentCandles[0].open, recentCandles[0].close) - recentCandles[0].low) < 0.000001 &&
                       Math.abs(Math.min(recentCandles[1].open, recentCandles[1].close) - recentCandles[1].low) < 0.000001;
            }
            
            return false;
        }

        // Check volume for entry
        function checkVolume(candles, volumeMAData) {
            if (candles.length < 2 || !volumeMAData || volumeMAData.length < 2) return false;
            
            const currentVolume = candles[candles.length - 1].volume;
            const currentVolumeMA = volumeMAData[volumeMAData.length - 1].value;
            
            return currentVolume >= currentVolumeMA * 1.5;
        }

        // Detect trade signals
        function detectTradeSignal(candle, ema50, ema100, atr) {
            try {
                if (!ema50 || !ema100 || !atr) return;
                
                const tradeSizePercent = parseFloat(document.getElementById('tradeSize').value) || 2;
                const atrMultiplier = parseFloat(document.getElementById('atrMultiplier').value) || 1.5;
                
                const isDojiCandle = isEnhancedDoji(candle, atr);
                if (!isDojiCandle) return;
                
                // Check for buy signal
                if (candle.close > ema100.value && ema50.value > ema100.value) {
                    const marketStructureValid = checkMarketStructure(heikinAshiCandles.slice(-5), true);
                    const pullbackValid = checkCleanPullback(heikinAshiCandles, 'buy');
                    const volumeValid = checkVolume(heikinAshiCandles, volumeMAData);
                    
                    if (marketStructureValid && pullbackValid && volumeValid) {
                        // Prefer green doji for buy
                        const isGreenDoji = candle.close > candle.open;
                        if (isGreenDoji) {
                            executeTrade('buy', candle, ema50, ema100, atr, atrMultiplier, tradeSizePercent);
                        }
                    }
                }
                // Check for sell signal
                else if (candle.close < ema100.value && ema50.value < ema100.value) {
                    const marketStructureValid = checkMarketStructure(heikinAshiCandles.slice(-5), false);
                    const pullbackValid = checkCleanPullback(heikinAshiCandles, 'sell');
                    const volumeValid = checkVolume(heikinAshiCandles, volumeMAData);
                    
                    if (marketStructureValid && pullbackValid && volumeValid) {
                        // Prefer red doji for sell
                        const isRedDoji = candle.close < candle.open;
                        if (isRedDoji) {
                            executeTrade('sell', candle, ema50, ema100, atr, atrMultiplier, tradeSizePercent);
                        }
                    }
                }
            } catch (error) {
                console.error('Error in trade detection:', error);
            }
        }

        // Execute trade with ATR-based stops
        function executeTrade(type, candle, ema50, ema100, atr, atrMultiplier, tradeSizePercent) {
            if (currentPosition) return; // Don't open new position if one is already open
            
            const tradeSize = accountBalance * (tradeSizePercent / 100);
            const entryPrice = type === 'buy' ? candle.high : candle.low;
            
            // ATR-based stops
            const stopLoss = type === 'buy' 
                ? entryPrice - (atr.value * atrMultiplier)
                : entryPrice + (atr.value * atrMultiplier);
                
            const takeProfit1 = type === 'buy' 
                ? entryPrice + (atr.value * atrMultiplier)
                : entryPrice - (atr.value * atrMultiplier);
                
            const takeProfit2 = type === 'buy' 
                ? entryPrice + (atr.value * atrMultiplier * 2)
                : entryPrice - (atr.value * atrMultiplier * 2);
            
            // Calculate position size based on risk
            const risk = Math.abs(entryPrice - stopLoss);
            const positionSize = tradeSize / risk;
            
            currentPosition = {
                type,
                entryPrice,
                stopLoss,
                takeProfit1,
                takeProfit2,
                positionSize,
                entryTime: candle.time,
                ema50AtEntry: ema50.value,
                ema100AtEntry: ema100.value
            };
            
            // Add markers to chart
            addTradeMarkers(candle.time, type, entryPrice, stopLoss, takeProfit1, takeProfit2);
            
            // Add to trade history
            const trade = {
                id: Date.now(),
                type,
                entryPrice,
                stopLoss,
                takeProfit1,
                takeProfit2,
                positionSize,
                entryTime: new Date(candle.time * 1000).toISOString(),
                exitTime: null,
                exitPrice: null,
                pnl: null,
                status: 'open',
                atr: atr.value
            };
            
            tradeHistory.unshift(trade);
            saveTradeHistory();
            updateTradeHistoryDisplay();
            
            // Update UI
            document.getElementById('currentPosition').textContent = `${type.toUpperCase()} @ $${entryPrice.toFixed(2)}`;
            document.getElementById('currentPosition').className = type === 'buy' ? 'text-green-400 font-mono font-semibold' : 'text-red-400 font-mono font-semibold';
            
            addAlert(`${type.toUpperCase()} signal executed at $${entryPrice.toFixed(2)} (ATR: ${atr.value.toFixed(2)})`, type);
        }

        // Close position
        function closePosition(exitPrice, exitTime, reason) {
            if (!currentPosition) return;
            
            const pnl = currentPosition.type === 'buy' 
                ? (exitPrice - currentPosition.entryPrice) * currentPosition.positionSize
                : (currentPosition.entryPrice - exitPrice) * currentPosition.positionSize;
            
            // Update account balance
            accountBalance += pnl;
            dailyPL += pnl;
            
            // Update trade history
            const openTrade = tradeHistory.find(t => t.status === 'open');
            if (openTrade) {
                openTrade.exitPrice = exitPrice;
                openTrade.exitTime = new Date(exitTime * 1000).toISOString();
                openTrade.pnl = pnl;
                openTrade.status = 'closed';
                openTrade.exitReason = reason;
            }
            
            saveTradeHistory();
            updateTradeHistoryDisplay();
            updateAccountDisplay();
            
            // Add alert
            const pnlText = pnl >= 0 ? `Profit: $${pnl.toFixed(2)}` : `Loss: $${Math.abs(pnl).toFixed(2)}`;
            addAlert(`Position closed at $${exitPrice.toFixed(2)} (${reason}) - ${pnlText}`, pnl >= 0 ? 'buy' : 'sell');
            
            // Clear current position
            currentPosition = null;
            document.getElementById('currentPosition').textContent = 'None';
            document.getElementById('currentPosition').className = 'text-blue-400 font-mono font-semibold';
            
            // Clear markers
            clearTradeMarkers();
        }

        // Add trade markers to chart
        function addTradeMarkers(time, type, entry, sl, tp1, tp2) {
            clearTradeMarkers();
            
            // Entry marker
            markers.push(candleSeries.createPriceLine({
                price: entry,
                color: type === 'buy' ? '#38ef7d' : '#ff6a00',
                lineWidth: 2,
                lineStyle: 0, // Solid
                axisLabelVisible: true,
                title: `${type.toUpperCase()} Entry`,
            }));
            
            // Stop loss marker
            markers.push(candleSeries.createPriceLine({
                price: sl,
                color: '#ff6a00',
                lineWidth: 1,
                lineStyle: 2, // Dashed
                axisLabelVisible: true,
                title: 'Stop Loss',
            }));
            
            // Take profit 1 marker
            markers.push(candleSeries.createPriceLine({
                price: tp1,
                color: '#38ef7d',
                lineWidth: 1,
                lineStyle: 2, // Dashed
                axisLabelVisible: true,
                title: 'Take Profit 1',
            }));
            
            // Take profit 2 marker
            markers.push(candleSeries.createPriceLine({
                price: tp2,
                color: '#38ef7d',
                lineWidth: 1,
                lineStyle: 2, // Dashed
                axisLabelVisible: true,
                title: 'Take Profit 2',
            }));
        }

        // Clear trade markers from chart
        function clearTradeMarkers() {
            markers.forEach(marker => {
                if (marker && typeof marker.remove === 'function') {
                    marker.remove();
                }
            });
            markers = [];
        }

        // Update trade history display
        function updateTradeHistoryDisplay() {
            const historyContainer = document.getElementById('tradeHistory');
            
            if (tradeHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <i class="fas fa-chart-line text-3xl mb-4 opacity-50"></i>
                        <p>No trades yet. Waiting for signals...</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = '';
            
            tradeHistory.slice(0, 20).forEach(trade => {
                const tradeDiv = document.createElement('div');
                tradeDiv.className = `alert ${trade.type} mb-4 transform hover:scale-105 transition-transform duration-200`;
                
                const pnlClass = trade.pnl >= 0 ? 'trade-profit' : 'trade-loss';
                const pnlText = trade.pnl !== null ? `$${Math.abs(trade.pnl).toFixed(2)}` : 'Pending';
                const exitText = trade.exitTime ? 
                    new Date(trade.exitTime).toLocaleTimeString() : 'Active';
                const exitReason = trade.exitReason ? ` (${trade.exitReason})` : '';
                
                tradeDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-lg flex items-center">
                            <i class="fas fa-${trade.type === 'buy' ? 'arrow-up text-green-400' : 'arrow-down text-red-400'} mr-3"></i>
                            ${trade.type.toUpperCase()} @ $${trade.entryPrice.toFixed(2)}
                        </div>
                        <div class="${pnlClass} text-lg font-semibold">
                            ${trade.pnl >= 0 ? '+' : '-'}${pnlText}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm mb-2">
                        <span class="text-gray-300">SL: <span class="text-red-400 font-mono">$${trade.stopLoss.toFixed(2)}</span></span>
                        <span class="text-gray-300">TP1: <span class="text-green-400 font-mono">$${trade.takeProfit1.toFixed(2)}</span></span>
                        <span class="text-gray-300">TP2: <span class="text-green-400 font-mono">$${trade.takeProfit2.toFixed(2)}</span></span>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:justify-between text-xs text-gray-400">
                        <div>
                            <i class="fas fa-clock mr-1"></i>
                            ${new Date(trade.entryTime).toLocaleTimeString()} → ${exitText}${exitReason}
                        </div>
                        ${trade.atr ? `<div class="mt-1 sm:mt-0">ATR: <span class="font-mono">${trade.atr.toFixed(2)}</span></div>` : ''}
                    </div>
                `;
                
                historyContainer.appendChild(tradeDiv);
            });
        }

        // Update account display
        function updateAccountDisplay() {
            document.getElementById('accountBalance').textContent = 
                `Balance: $${accountBalance.toFixed(2)}`;
            document.getElementById('dailyPL').textContent = 
                dailyPL >= 0 ? `$${dailyPL.toFixed(2)}` : `-$${Math.abs(dailyPL).toFixed(2)}`;
            document.getElementById('dailyPL').className = 
                dailyPL >= 0 ? 'text-green-400 font-mono font-semibold' : 'text-red-400 font-mono font-semibold';
        }

        // UI Update functions
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const statusMap = {
                'connected': { 
                    class: 'status-connected', 
                    text: 'Connected', 
                    icon: '<i class="fas fa-circle animate-pulse-custom"></i>' 
                },
                'disconnected': { 
                    class: 'status-disconnected', 
                    text: 'Disconnected', 
                    icon: '<i class="fas fa-circle"></i>' 
                },
                'connecting': { 
                    class: 'status-badge bg-yellow-500 bg-opacity-20 border-yellow-500 text-yellow-400', 
                    text: 'Connecting...', 
                    icon: '<div class="loading-spinner"></div>' 
                },
                'error': { 
                    class: 'status-disconnected', 
                    text: 'Connection Error', 
                    icon: '<i class="fas fa-exclamation-triangle"></i>' 
                }
            };
            
            const config = statusMap[status] || statusMap['error'];
            statusElement.className = `status-badge ${config.class}`;
            statusElement.innerHTML = `${config.icon} ${config.text}`;
        }

        function updatePriceDisplay(candle) {
            const priceElement = document.getElementById('currentPrice');
            const change = lastPrice > 0 ? ((candle.close - lastPrice) / lastPrice * 100) : 0;
            
            priceElement.textContent = `$${candle.close.toFixed(2)}`;
            priceElement.className = candle.close >= candle.open ? 'text-green-400 font-mono font-semibold' : 'text-red-400 font-mono font-semibold';
            
            lastPrice = candle.close;
            
            // Check if we need to close position
            if (currentPosition) {
                const currentCandle = heikinAshiCandles[heikinAshiCandles.length - 1];
                const currentEMA50 = ema50Data[ema50Data.length - 1];
                const currentEMA100 = ema100Data[ema100Data.length - 1];
                
                // Check stop loss
                if ((currentPosition.type === 'buy' && currentCandle.low <= currentPosition.stopLoss) ||
                    (currentPosition.type === 'sell' && currentCandle.high >= currentPosition.stopLoss)) {
                    closePosition(
                        currentPosition.stopLoss,
                        currentCandle.time,
                        'SL Hit'
                    );
                }
                // Check take profit 1
                else if ((currentPosition.type === 'buy' && currentCandle.high >= currentPosition.takeProfit1) ||
                         (currentPosition.type === 'sell' && currentCandle.low <= currentPosition.takeProfit1)) {
                    closePosition(
                        currentPosition.takeProfit1,
                        currentCandle.time,
                        'TP1 Hit'
                    );
                }
                // Check take profit 2
                else if ((currentPosition.type === 'buy' && currentCandle.high >= currentPosition.takeProfit2) ||
                         (currentPosition.type === 'sell' && currentCandle.low <= currentPosition.takeProfit2)) {
                    closePosition(
                        currentPosition.takeProfit2,
                        currentCandle.time,
                        'TP2 Hit'
                    );
                }
                // Check if trend is reversing (EMA cross)
                else if (currentPosition.type === 'buy' && currentEMA50 && currentEMA100 &&
                         (currentEMA50.value < currentEMA100.value || currentCandle.close < currentEMA100.value)) {
                    closePosition(
                        currentCandle.close,
                        currentCandle.time,
                        'Trend Reversal'
                    );
                }
                else if (currentPosition.type === 'sell' && currentEMA50 && currentEMA100 &&
                         (currentEMA50.value > currentEMA100.value || currentCandle.close > currentEMA100.value)) {
                    closePosition(
                        currentCandle.close,
                        currentCandle.time,
                        'Trend Reversal'
                    );
                }
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').innerHTML = 
                `<i class="fas fa-sync-alt mr-1"></i>Updated: ${now.toLocaleTimeString()}`;
        }

        function addAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type} transform transition-all duration-300 hover:scale-105`;
            
            const now = new Date();
            const typeIcon = type === 'buy' ? 'fas fa-arrow-up text-green-400' : 
                           type === 'sell' ? 'fas fa-arrow-down text-red-400' : 
                           'fas fa-info-circle text-blue-400';
            
            alertDiv.innerHTML = `
                <div class="font-semibold flex items-center mb-1">
                    <i class="${typeIcon} mr-2"></i>
                    <span class="capitalize">${type}</span>
                </div>
                <div class="text-sm text-gray-200 mb-2">${message}</div>
                <div class="text-xs text-gray-400 flex items-center">
                    <i class="fas fa-clock mr-1"></i>${now.toLocaleTimeString()}
                </div>
            `;
            
            const alertsContainer = document.getElementById('signals');
            
            // Remove placeholder if it exists
            const placeholder = alertsContainer.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            alertsContainer.insertBefore(alertDiv, alertsContainer.firstChild);
            
            // Keep only last 5 alerts
            while (alertsContainer.children.length > 5) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
            
            // Add entrance animation
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                alertDiv.style.opacity = '1';
                alertDiv.style.transform = 'translateY(0)';
            }, 100);
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.close();
            }
        });
    </script>
</body>
</html>
